name: Create Github Release

on:
  workflow_run:
    workflows: ["Run Tests"]
    types:
      - completed
    branches:
      - '**'
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag to create release for (e.g., v1.0.0rc1)"
        required: true
        type: string

jobs:
  create-release:
    runs-on: ubuntu-latest
    # Only run if tests passed and this is a tag push, or manual dispatch
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event.workflow_run.conclusion == 'success' && startsWith(github.event.workflow_run.head_branch, 'refs/tags/v'))

    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          ref: ${{ (github.event_name == 'workflow_dispatch' && github.event.inputs.tag) || github.event.workflow_run.head_branch }}

      - name: Extract version information
        id: version_info
        run: |
          # Determine version based on trigger type
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.tag }}"
          else
            VERSION="${{ github.event.workflow_run.head_branch }}"
          fi

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Detected version: $VERSION"

          # Check if current version is pre-release (e.g. alpha / beta / rc)
          if [[ "$VERSION" =~ v[0-9]+\.[0-9]+\.[0-9]+([a-zA-Z]+[0-9]*)$ ]]; then
            echo "is_prerelease=true" >> $GITHUB_OUTPUT
            echo "prerelease_tag=${BASH_REMATCH[1]}" >> $GITHUB_OUTPUT
            echo "release_name=$VERSION" >> $GITHUB_OUTPUT
            echo "Detected as prerelease with tag: ${BASH_REMATCH[1]}"
          else
            echo "is_prerelease=false" >> $GITHUB_OUTPUT
            echo "prerelease_tag=" >> $GITHUB_OUTPUT
            echo "release_name=$VERSION" >> $GITHUB_OUTPUT
            echo "Detected as stable release"
          fi

      - name: Extract changelog content
        id: changelog
        run: |
          # https://medium.com/%40usman_qb/from-git-tag-to-github-release-automating-changelog-extraction-9cfcad1b13c4
          # Get version from previous step
          VERSION="${{ steps.version_info.outputs.version }}"
          # Remove 'v' prefix if it exists for matching changelog
          VERSION_NUMBER="${VERSION#v}"

          # Extract content between the version header and the next version header
          awk -v version="$VERSION_NUMBER" '
            BEGIN { found=0; print_content=0 }
            /^## / {
              if (found && print_content) {
                exit
              }
              if ($0 ~ version) {
                found=1
                print_content=1
                next
              }
            }
            found && print_content && !/^## / {
              print $0
            }
          ' CHANGELOG.md > release_notes.md

          # Check if we found any content
          if [ ! -s release_notes.md ]; then
            echo "See [CHANGELOG.md](./CHANGELOG.md) for details." >> release_notes.md
          fi

      - name: Create Github Release
        id: create_release
        run: |
          if [ "${{ steps.version_info.outputs.is_prerelease }}" = "true" ]; then
            echo "Create release for version ${{ steps.version_info.outputs.version }} (Pre-release)"
            gh release create "${{ steps.version_info.outputs.version }}" \
              --title "${{ steps.version_info.outputs.release_name }}" \
              --notes-file release_notes.md \
              --prerelease
          else
            echo "Create release for version ${{ steps.version_info.outputs.version }}"
            gh release create "${{ steps.version_info.outputs.version }}" \
              --title "${{ steps.version_info.outputs.release_name }}" \
              --notes-file release_notes.md
          fi
          echo "Create release successfully"
        env:
          GH_TOKEN: ${{secrets.GITHUB_TOKEN}}
